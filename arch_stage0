#!/bin/bash

INSTALL_PACKAGES=$(sed 's/\s\+/ /g ; s/^\s*//' <<< "${INSTALL_PACKAGES//$'\n'/ }")
INSTALL_SERVICES=$(sed 's/\s\+/ /g ; s/^\s*//' <<< "${INSTALL_SERVICES//$'\n'/ }")

for var in ${!INSTALL_*}; do
    read -p "${var}: " -e -i "${!var}" ${var} 0<&4
    export ${var}
done

for func in configure_disk post_install; do
    if [ "$(type -t ${func})" = function ]; then
        export -f ${func}
    fi
done

export INSTALL_DISK_ENCRYPTION="${INSTALL_DISK_ENCRYPTION:-luks}"
export INSTALL_GRUB_DISK="${INSTALL_GRUB_DISK:-/dev/sda}"
export INSTALL_GRUB_CMDLINE="${INSTALL_GRUB_CMDLINE:-quiet}"

get() { curl -s http://${INSTALL_HOST}/$1; }

source <(get arch_fn)
bash -e <(get arch_stage1)
arch-chroot /mnt bash -e <(get arch_stage2)

umount -R /mnt
swapoff -a

case "${INSTALL_DISK_ENCRYPTION}" in
    luks)
        lsblk -P \
            | sed -rn '/TYPE="crypt"/ { s/^NAME="([^ ]*)" .*$/\1/ ; p }' \
            | xargs -n 1 cryptsetup close
        ;;
esac
